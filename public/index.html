<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#F7F8FA" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="JyP Ventas">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">
  <link rel="manifest" href="/manifest.webmanifest" />
  <title>JyP Ventas</title>
  <script src="/js/vendor/tailwindcss-playcdn.js"></script>
  <link rel="stylesheet" href="/css/theme.css" />
  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>

<body class="h-screen overflow-hidden flex flex-col">
  <header id="appShellTop"></header>

  <main id="mainScroll" class="flex-1 overflow-y-auto pb-20">
    <div id="list" class="divide-y divider"></div>
    <div id="emptyState" class="hidden p-4 text-sm text-muted">No hay productos para mostrar.</div>
    <div id="statusLine" class="p-3 text-xs text-subtle"></div>
  </main>

  <nav id="appShellBottom"></nav>

  <script type="module">
    import { requireAuth } from "/js/auth.js";
    import { registerServiceWorker, applyUpdate } from "/js/sw-register.js";
    import { getProducts } from "/js/catalog-service.js";
    import { getImageUrl } from "/js/image.js";
    import { addToCart, getCart } from "/js/cart.js";
    import { initAppShell } from "/js/app-shell.js";

    let searchInputEl = null;
    const listEl = document.getElementById("list");
    const emptyStateEl = document.getElementById("emptyState");
    const statusLineEl = document.getElementById("statusLine");

    const TABS = {
      "botellas": "Botellas",
      "perfumes": "Perfumes",
      "importados": "Importados",
      "outlet": "Outlet",
      "home": "Home"
    };

    let products = [];
    let selectedTab = "perfumes";
    let pendingReg = null;
    const tabFromUrl = new URLSearchParams(location.search).get("tab");
    if (!tabFromUrl) {
      location.replace("/pages/home.html");
      await new Promise(() => {});
    }
    if (tabFromUrl && TABS[tabFromUrl]) {
      selectedTab = tabFromUrl;
    }

    function fmtMoney(value) {
      const n = Number(value ?? 0);
      return new Intl.NumberFormat("es-AR", { maximumFractionDigits: 0 }).format(n);
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normalizeSlug(value) {
      return String(value ?? "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/\p{Diacritic}/gu, "")
        .replace(/\s+/g, "-");
    }

    function qtyInCart(productId) {
      const item = getCart().find((x) => x.product_id === productId);
      return Number(item?.qty || 0);
    }

    function currentTabLabel() {
      return TABS[selectedTab] ?? "Productos";
    }

    function updateTabUi() {
      document.querySelectorAll("[data-shell-tab]").forEach((btn) => {
        const active = btn.getAttribute("data-shell-tab") === selectedTab;
        btn.classList.toggle("chip-active", active);
        btn.classList.toggle("text-muted", !active);
      });
    }

    function renderList(rows) {
      if (!rows.length) {
        listEl.innerHTML = "";
        emptyStateEl.classList.remove("hidden");
        statusLineEl.textContent = "Sin resultados para esta categoria/filtro.";
        return;
      }

      emptyStateEl.classList.add("hidden");
      listEl.innerHTML = rows.map((p) => {
        const img = p.image_path ? getImageUrl(String(p.image_path).trim().replace(/^\/+/, "")) : "";
        const qty = qtyInCart(p.id);

        return `
          <article class="px-3 py-2">
            <div class="flex items-center gap-3 card p-2.5">
              <a href="/pages/producto.html?id=${encodeURIComponent(p.id)}" class="block shrink-0">
                <img src="${img}" class="w-[70px] h-[70px] rounded-lg border divider bg-surface-2 object-contain" />
              </a>

              <a href="/pages/producto.html?id=${encodeURIComponent(p.id)}" class="min-w-0 flex-1">
                <h2 class="font-semibold text-sm leading-5 line-clamp-2">${escapeHtml(p.name)}</h2>
                <p class="text-xs text-muted mt-1">$ ${fmtMoney(p.price)}</p>
              </a>

              <div class="w-14 flex flex-col items-end gap-2">
                <span class="text-xs text-muted">${qty}</span>
                <button
                  type="button"
                  data-add-id="${escapeHtml(p.id)}"
                  data-add-name="${escapeHtml(p.name)}"
                  data-add-price="${Number(p.price ?? 0)}"
                  data-add-image="${escapeHtml(p.image_path ?? "")}"
                  class="btn btn-primary w-11 h-11 rounded-full p-0"
                  aria-label="Agregar al carrito">
                  <span class="flex items-center justify-center text-emerald-600">
                    <svg viewBox="0 0 24 24" class="w-6 h-6 stroke-[1.8]" fill="none" stroke="currentColor" aria-hidden="true">
                      <path d="M12 5v14"></path>
                      <path d="M5 12h14"></path>
                    </svg>
                  </span>
                </button>
              </div>
            </div>
          </article>
        `;
      }).join("");

      listEl.querySelectorAll("[data-add-id]").forEach((btn) => {
        btn.addEventListener("click", (event) => {
          event.preventDefault();
          event.stopPropagation();

          addToCart({
            id: btn.getAttribute("data-add-id"),
            name: btn.getAttribute("data-add-name"),
            price: Number(btn.getAttribute("data-add-price") || 0),
            image_path: btn.getAttribute("data-add-image") || ""
          }, 1);

          applyFilters();
          statusLineEl.textContent = "Producto agregado al carrito.";
        });
      });
    }

    function applyFilters() {
      const q = (searchInputEl?.value || "").toLowerCase().trim();
      const rows = products.filter((p) => {
        const name = String(p.name ?? "").toLowerCase();
        const slug = normalizeSlug(p.categories?.slug ?? p.categories?.name ?? "");

        const matchTab = !selectedTab || slug === selectedTab;
        const matchSearch = !q || name.includes(q);
        return matchTab && matchSearch;
      });

      renderList(rows);
      statusLineEl.textContent = `${rows.length} producto(s) en ${currentTabLabel()}.`;
    }

    async function reloadProducts() {
      statusLineEl.textContent = "Actualizando catalogo...";
      products = await getProducts();

      const hasPerfumes = products.some((p) => normalizeSlug(p.categories?.slug ?? p.categories?.name ?? "") === "perfumes");
      if (!hasPerfumes) {
        const firstWithCategory = products.find((p) => normalizeSlug(p.categories?.slug ?? p.categories?.name ?? ""));
        selectedTab = normalizeSlug(firstWithCategory?.categories?.slug ?? firstWithCategory?.categories?.name ?? "");
      }

      updateTabUi();
      applyFilters();
    }

    const session = await requireAuth();
    if (!session) throw new Error("Redirecting to login...");

    initAppShell({
      title: "Perfumes",
      onRefresh: reloadProducts
    });

    searchInputEl = document.getElementById("appShellSearchInput");

    registerServiceWorker({
      onUpdate: (reg) => {
        pendingReg = reg;
        document.getElementById("updateBanner")?.classList.remove("hidden");
      }
    });

    document.getElementById("btnUpdate")?.addEventListener("click", () => applyUpdate(pendingReg), { once: true });

    document.querySelectorAll("[data-shell-tab]").forEach((btn) => {
      btn.addEventListener("click", (event) => {
        event.preventDefault();
        const value = btn.getAttribute("data-shell-tab") || "";
        if (value === "home") {
          location.href = "/pages/home.html";
          return;
        }
        selectedTab = value;
        history.replaceState({}, "", `/index.html?tab=${encodeURIComponent(value)}`);
        updateTabUi();
        applyFilters();
      });
    });

    searchInputEl?.addEventListener("input", applyFilters);
    window.addEventListener("cart:changed", applyFilters);

    await reloadProducts();
  </script>
</body>
</html>
