<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="JyP Ventas">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">

  <link rel="manifest" href="/manifest.webmanifest" />
  <title>JyP Ventas</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>

<body class="h-screen overflow-hidden flex flex-col bg-slate-950 text-slate-100">
  <header class="sticky top-0 z-30 border-b border-slate-800 bg-slate-950/95 backdrop-blur">
    <div class="px-3 py-2 flex items-center gap-2">
      <button id="btnMenu" class="w-9 h-9 rounded-lg border border-slate-700 inline-flex items-center justify-center" aria-label="Menu">
        <svg viewBox="0 0 24 24" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18"></path>
          <path d="M3 12h18"></path>
          <path d="M3 18h18"></path>
        </svg>
      </button>

      <div class="w-8 h-8 rounded-md bg-emerald-400 text-slate-950 text-xs font-bold inline-flex items-center justify-center">JYP</div>
      <h1 id="headerTitle" class="text-base font-semibold truncate">Perfumes</h1>

      <div class="ml-auto flex items-center gap-1">
        <button id="btnSearch" class="w-9 h-9 rounded-lg border border-slate-700 inline-flex items-center justify-center" aria-label="Buscar">
          <svg viewBox="0 0 24 24" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="7"></circle>
            <path d="M20 20l-3.5-3.5"></path>
          </svg>
        </button>

        <button id="btnSelectMode" class="w-9 h-9 rounded-lg border border-slate-700 inline-flex items-center justify-center" aria-label="Modo seleccion">
          <svg viewBox="0 0 24 24" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 6L9 17l-5-5"></path>
          </svg>
        </button>

        <button id="btnAdd" class="w-9 h-9 rounded-lg border border-slate-700 inline-flex items-center justify-center" aria-label="Agregar">
          <svg viewBox="0 0 24 24" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14"></path>
            <path d="M5 12h14"></path>
          </svg>
        </button>

        <button id="btnRefresh" class="w-9 h-9 rounded-lg border border-slate-700 inline-flex items-center justify-center" aria-label="Recargar">
          <svg viewBox="0 0 24 24" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12a9 9 0 1 1-2.64-6.36"></path>
            <path d="M21 3v6h-6"></path>
          </svg>
        </button>
      </div>
    </div>

    <div id="searchWrap" class="hidden px-3 pb-2">
      <input id="searchInput" class="w-full px-3 py-2 rounded-xl bg-slate-900 border border-slate-700" placeholder="Buscar producto..." />
    </div>

    <div id="updateBanner" class="hidden px-3 pb-2">
      <button id="btnUpdate" class="w-full text-left px-3 py-2 rounded-lg border border-amber-500/30 bg-amber-500/10 text-amber-100 text-sm">
        Hay una nueva version disponible. Tocar para actualizar.
      </button>
    </div>
  </header>

  <main id="mainScroll" class="flex-1 overflow-y-auto pb-20">
    <div id="list" class="divide-y divide-slate-800"></div>
    <div id="emptyState" class="hidden p-4 text-sm text-slate-300">No hay productos para mostrar.</div>
    <div id="statusLine" class="p-3 text-xs text-slate-400"></div>
  </main>

  <nav class="fixed bottom-0 left-0 right-0 z-30 border-t border-slate-800 bg-slate-950/95 backdrop-blur">
    <div class="grid grid-cols-5">
      <button data-tab="botellas" class="tab-btn py-2 text-[11px] text-slate-400 flex flex-col items-center gap-1">
        <span>🍾</span><span>Botellas</span>
      </button>
      <button data-tab="perfumes" class="tab-btn py-2 text-[11px] text-slate-100 flex flex-col items-center gap-1 bg-slate-900/80">
        <span>🧴</span><span>Perfumes</span>
      </button>
      <button data-tab="importados" class="tab-btn py-2 text-[11px] text-slate-400 flex flex-col items-center gap-1">
        <span>🌍</span><span>Importados</span>
      </button>
      <button data-tab="outlet" class="tab-btn py-2 text-[11px] text-slate-400 flex flex-col items-center gap-1">
        <span>🏷️</span><span>Outlet</span>
      </button>
      <button data-tab="reservas-pendiente" class="tab-btn py-2 text-[11px] text-slate-400 flex flex-col items-center gap-1">
        <span>⏳</span><span>Reservas</span>
      </button>
    </div>
  </nav>

  <script type="module">
    import { requireAuth } from "/js/auth.js";
    import { registerServiceWorker, applyUpdate } from "/js/sw-register.js";
    import { getProducts } from "/js/catalog-service.js";
    import { getImageUrl } from "/js/image.js";
    import { addToCart, getCart } from "/js/cart.js";

    const headerTitleEl = document.getElementById("headerTitle");
    const searchWrapEl = document.getElementById("searchWrap");
    const searchInputEl = document.getElementById("searchInput");
    const listEl = document.getElementById("list");
    const emptyStateEl = document.getElementById("emptyState");
    const statusLineEl = document.getElementById("statusLine");
    const updateBannerEl = document.getElementById("updateBanner");
    const btnUpdateEl = document.getElementById("btnUpdate");

    const TABS = {
      "botellas": "Botellas",
      "perfumes": "Perfumes",
      "importados": "Importados",
      "outlet": "Outlet",
      "reservas-pendiente": "Reservas Pendiente"
    };

    let products = [];
    let selectedTab = "perfumes";
    let selectMode = false;
    let pendingReg = null;

    function fmtMoney(value) {
      const n = Number(value ?? 0);
      return new Intl.NumberFormat("es-AR", { maximumFractionDigits: 0 }).format(n);
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normalizeSlug(value) {
      return String(value ?? "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/\p{Diacritic}/gu, "")
        .replace(/\s+/g, "-");
    }

    function qtyInCart(productId) {
      const item = getCart().find((x) => x.product_id === productId);
      return Number(item?.qty || 0);
    }

    function currentTabLabel() {
      return TABS[selectedTab] ?? "Productos";
    }

    function updateTabUi() {
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        const active = btn.getAttribute("data-tab") === selectedTab;
        btn.classList.toggle("bg-slate-900/80", active);
        btn.classList.toggle("text-slate-100", active);
        btn.classList.toggle("text-slate-400", !active);
      });
      headerTitleEl.textContent = currentTabLabel();
    }

    function renderList(rows) {
      if (!rows.length) {
        listEl.innerHTML = "";
        emptyStateEl.classList.remove("hidden");
        statusLineEl.textContent = "Sin resultados para esta categoria/filtro.";
        return;
      }

      emptyStateEl.classList.add("hidden");
      listEl.innerHTML = rows.map((p) => {
        const img = p.image_path ? getImageUrl(String(p.image_path).trim().replace(/^\/+/, "")) : "";
        const qty = qtyInCart(p.id);

        return `
          <article class="px-3 py-2">
            <div class="flex items-center gap-3">
              <a href="/pages/producto.html?id=${encodeURIComponent(p.id)}" class="block shrink-0">
                <img src="${img}" class="w-[70px] h-[70px] rounded-lg border border-slate-800 bg-slate-900 object-contain" />
              </a>

              <a href="/pages/producto.html?id=${encodeURIComponent(p.id)}" class="min-w-0 flex-1">
                <h2 class="font-semibold text-sm leading-5 line-clamp-2">${escapeHtml(p.name)}</h2>
                <p class="text-xs text-slate-400 mt-1">$ ${fmtMoney(p.price)}</p>
              </a>

              <div class="w-14 flex flex-col items-end gap-2">
                <span class="text-xs text-slate-400">${qty}</span>
                <button
                  type="button"
                  data-add-id="${escapeHtml(p.id)}"
                  data-add-name="${escapeHtml(p.name)}"
                  data-add-price="${Number(p.price ?? 0)}"
                  data-add-image="${escapeHtml(p.image_path ?? "")}"
                  class="w-9 h-9 rounded-full bg-emerald-400 text-slate-950 inline-flex items-center justify-center"
                  aria-label="Agregar al carrito">
                  <svg viewBox="0 0 24 24" class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="9" cy="20" r="1"></circle>
                    <circle cx="17" cy="20" r="1"></circle>
                    <path d="M3 4h2l2.2 10.2a1 1 0 0 0 1 .8h8.8a1 1 0 0 0 1-.8L20 7H7"></path>
                    <path d="M12 9v4"></path>
                    <path d="M10 11h4"></path>
                  </svg>
                </button>
              </div>
            </div>
          </article>
        `;
      }).join("");

      listEl.querySelectorAll("[data-add-id]").forEach((btn) => {
        btn.addEventListener("click", (event) => {
          event.preventDefault();
          event.stopPropagation();

          addToCart({
            id: btn.getAttribute("data-add-id"),
            name: btn.getAttribute("data-add-name"),
            price: Number(btn.getAttribute("data-add-price") || 0),
            image_path: btn.getAttribute("data-add-image") || ""
          }, 1);

          applyFilters();
          statusLineEl.textContent = "Producto agregado al carrito.";
        });
      });
    }

    function applyFilters() {
      const q = (searchInputEl.value || "").toLowerCase().trim();
      const rows = products.filter((p) => {
        const name = String(p.name ?? "").toLowerCase();
        const slug = normalizeSlug(p.categories?.slug ?? p.categories?.name ?? "");

        const matchTab = !selectedTab || slug === selectedTab;
        const matchSearch = !q || name.includes(q);
        return matchTab && matchSearch;
      });

      renderList(rows);
      statusLineEl.textContent = `${rows.length} producto(s) en ${currentTabLabel()}.`;
    }

    async function reloadProducts() {
      statusLineEl.textContent = "Actualizando catalogo...";
      products = await getProducts();

      const hasPerfumes = products.some((p) => normalizeSlug(p.categories?.slug ?? p.categories?.name ?? "") === "perfumes");
      if (!hasPerfumes) {
        const firstWithCategory = products.find((p) => normalizeSlug(p.categories?.slug ?? p.categories?.name ?? ""));
        selectedTab = normalizeSlug(firstWithCategory?.categories?.slug ?? firstWithCategory?.categories?.name ?? "");
      }

      updateTabUi();
      applyFilters();
    }

    const session = await requireAuth();
    if (!session) throw new Error("Redirecting to login...");

    registerServiceWorker({
      onUpdate: (reg) => {
        pendingReg = reg;
        updateBannerEl.classList.remove("hidden");
      }
    });

    btnUpdateEl.addEventListener("click", () => applyUpdate(pendingReg), { once: true });

    document.getElementById("btnMenu").addEventListener("click", () => {
      location.href = "/pages/pedidos.html";
    });

    document.getElementById("btnSearch").addEventListener("click", () => {
      searchWrapEl.classList.toggle("hidden");
      if (!searchWrapEl.classList.contains("hidden")) searchInputEl.focus();
      else searchInputEl.value = "";
      applyFilters();
    });

    document.getElementById("btnSelectMode").addEventListener("click", (e) => {
      selectMode = !selectMode;
      e.currentTarget.classList.toggle("bg-emerald-400", selectMode);
      e.currentTarget.classList.toggle("text-slate-950", selectMode);
      statusLineEl.textContent = selectMode
        ? "Modo seleccion activado (visual)."
        : "Modo seleccion desactivado.";
    });

    document.getElementById("btnAdd").addEventListener("click", () => {
      location.href = "/pages/pedido.html";
    });

    document.getElementById("btnRefresh").addEventListener("click", async () => {
      await reloadProducts();
    });

    document.querySelectorAll(".tab-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        selectedTab = btn.getAttribute("data-tab") || "";
        updateTabUi();
        applyFilters();
      });
    });

    searchInputEl.addEventListener("input", applyFilters);
    window.addEventListener("cart:changed", applyFilters);

    await reloadProducts();
  </script>
</body>
</html>
