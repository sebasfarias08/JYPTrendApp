<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#F7F8FA" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <title>Ingresando...</title>
  <script src="/js/vendor/tailwindcss-playcdn.js"></script>
  <link rel="stylesheet" href="/css/theme.css" />
</head>

<body class="h-screen overflow-hidden flex flex-col">
  <header id="appShellTop"></header>

  <main class="flex-1 overflow-y-auto p-4 pb-24">
    <div class="card p-4">Ingresando...</div>
  </main>

  <nav id="appShellBottom"></nav>

  <script type="module">
    import { supabase } from "/js/supabase-client.js";
    import { initAppShell } from "/js/app-shell.js";

    initAppShell({
      title: "Ingresando",
      onRefresh: async () => location.reload()
    });

    const next = new URLSearchParams(location.search).get("next");
    const fallbackTarget = "/pages/home.html";
    const target = next ? decodeURIComponent(next) : fallbackTarget;

    let hasNavigated = false;
    let fallbackTimer = null;
    const navigateOnce = (url) => {
      if (hasNavigated) return;
      hasNavigated = true;
      if (fallbackTimer) clearTimeout(fallbackTimer);
      location.replace(url);
    };

    const { data } = await supabase.auth.getSession();
    if (data?.session) {
      navigateOnce(target);
    } else {
      const { data: sub } = supabase.auth.onAuthStateChange((_event, session) => {
        if (session) {
          sub.subscription.unsubscribe();
          navigateOnce(target);
        }
      });

      fallbackTimer = setTimeout(async () => {
        const { data: retry } = await supabase.auth.getSession();
        if (retry?.session) {
          navigateOnce(target);
          return;
        }
        navigateOnce(`/pages/login.html?next=${encodeURIComponent(target)}`);
      }, 10000);
    }
  </script>
</body>
</html>
